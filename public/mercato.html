<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mercato</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Mercato</h1>
  
  <div>
    <h2>Svincola Giocatore</h2>
    <label>Squadra:
      <select id="squadraSelect">
        <option value="">Seleziona squadra...</option>
      </select>
    </label>
    <input type="password" id="passwordInput" placeholder="Password">
    <button id="btnCaricaRosa">Carica Rosa</button>
  </div>

  <div id="rosaContainer" style="display:none;">
    <h3>Rosa di <span id="nomeSquadra"></span></h3>
    <p>Crediti disponibili: <span id="crediti"></span></p>
    <p>Svincoli disponibili: <span id="svincoli"></span></p>
    
    <div id="giocatoriRosa"></div>
    
    <h3>Acquista Giocatore</h3>
    <input type="text" id="searchGiocatore" placeholder="Cerca giocatore...">
    <button id="btnCercaGiocatore">Cerca</button>
    <div id="risultatiRicerca"></div>
  </div>

  <button onclick="location.href='index.html'">‚Üê Torna alla Home</button>

  <script>
    const squadre = [
      "Kira team", "AC TUA", "FC Paulo Team", "i compagni del secolo",
      "Horto Muso", "Macelleria Gioielleria", "Magola UtD", 
      "PakiGio 2125", "rufy team fc", "SCOOBY GUD fc"
    ];

    // Popola select squadre
    const select = document.getElementById("squadraSelect");
    squadre.forEach(s => {
      const option = document.createElement("option");
      option.value = s;
      option.textContent = s;
      select.appendChild(option);
    });

    document.getElementById("btnCaricaRosa").addEventListener("click", async () => {
      const squadra = document.getElementById("squadraSelect").value;
      const password = document.getElementById("passwordInput").value;
      
      if (!squadra || !password) {
        alert("Seleziona squadra e inserisci password");
        return;
      }

      try {
        const res = await fetch("/api/mercato/rosa", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ squadra, password })
        });
        
        const data = await res.json();
        if (!res.ok) {
          alert(data.error);
          return;
        }

        document.getElementById("nomeSquadra").textContent = squadra;
        document.getElementById("crediti").textContent = data.crediti;
        document.getElementById("svincoli").textContent = data.svincoli_disponibili;
        
        const container = document.getElementById("giocatoriRosa");
        container.innerHTML = "";
        
        data.giocatori.forEach(g => {
          const div = document.createElement("div");
          div.innerHTML = `
            <span>${g.nome} - ${g.ruolo || ''} (${g.squadra || ''}) - Q: ${g.quotazione}</span>
            <button onclick="svincolaGiocatore('${g.nome}', ${g.quotazione})" ${data.svincoli_disponibili <= 0 ? 'disabled' : ''}>Svincola</button>
          `;
          container.appendChild(div);
        });

        document.getElementById("rosaContainer").style.display = "block";
      } catch (err) {
        alert("Errore: " + err.message);
      }
    });

    async function svincolaGiocatore(nome, quotazione) {
      const squadra = document.getElementById("squadraSelect").value;
      const password = document.getElementById("passwordInput").value;
      
      if (!confirm(`Vuoi svincolare ${nome}? Riceverai ${quotazione} crediti.`)) return;

      try {
        const res = await fetch("/api/mercato/svincola", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ squadra, password, giocatore: nome, quotazione })
        });
        
        const data = await res.json();
        if (!res.ok) {
          alert(data.error);
          return;
        }

        alert(`${nome} svincolato! Nuovi crediti: ${data.nuoviCrediti}`);
        document.getElementById("btnCaricaRosa").click(); // Ricarica rosa
      } catch (err) {
        alert("Errore: " + err.message);
      }
    }

    document.getElementById("btnCercaGiocatore").addEventListener("click", async () => {
      const search = document.getElementById("searchGiocatore").value.trim();
      if (!search) return;

      try {
        const res = await fetch(`/api/giocatori?search=${encodeURIComponent(search)}`);
        const giocatori = await res.json();
        
        const container = document.getElementById("risultatiRicerca");
        container.innerHTML = "";
        
        giocatori.forEach(g => {
          const div = document.createElement("div");
          div.innerHTML = `
            <span>${g.nome} - ${g.ruolo} (${g.squadra}) - Q: ${g.qa}</span>
            <button onclick="acquistagiocatore('${g.nome}', '${g.ruolo}', ${g.qa})">Acquista</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        alert("Errore: " + err.message);
      }
    });

    async function acquistagiocatore(nome, ruolo, quotazione) {
      const squadra = document.getElementById("squadraSelect").value;
      const password = document.getElementById("passwordInput").value;
      
      if (!confirm(`Vuoi acquistare ${nome} per ${quotazione} crediti?`)) return;

      try {
        const res = await fetch("/api/mercato/acquista", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ squadra, password, giocatore: nome, ruolo, quotazione })
        });
        
        const data = await res.json();
        if (!res.ok) {
          alert(data.error);
          return;
        }

        alert(`${nome} acquistato! Nuovi crediti: ${data.nuoviCrediti}`);
        document.getElementById("btnCaricaRosa").click(); // Ricarica rosa
        document.getElementById("risultatiRicerca").innerHTML = ""; // Pulisci ricerca
      } catch (err) {
        alert("Errore: " + err.message);
      }
    }
  </script>
</body>
</html>