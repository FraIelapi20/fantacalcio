<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Fantacalcio</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Gestione Fantacalcio Champions FantaTuttoO</h1>

  <!-- Rose -->
  <section>
    <h2>Rose</h2>
    <div id="rose"></div>
  </section>

  <!-- Inserisci formazione -->
  <section>
    <h2>Inserisci formazione</h2>
    <label>Scegli squadra: <select id="squadreSel"></select></label>
    <br>
    <label>Password: <input type="password" id="pwdForm"></label>
    <br><br>
    <div id="listaGiocatori"></div>
    <br>
    <button id="btnInviaForm">Invia Formazione</button>
    <pre id="msgForm"></pre>
  </section>

  <!-- Classifica -->
  <section>
    <h2>Classifica</h2>
    <table id="classificaTbl"></table>
  </section>

  <!-- Calendario -->
<section>
  <h2>Calendario</h2>
  <label>Seleziona giornata: 
    <select id="selGiornata"></select>
  </label>
  <div id="calendarioContainer"></div>
</section>

<section>
  <h2>Calcola giornata</h2>
  <button id="btnMostraCalcola">Mostra giornata da calcolare</button>
  <div id="calcArea"></div>
</section>

<script>
let roseData = [];
let titolari = new Set();
let panchina = new Set();

// --- Carica rose ---
async function loadRose() {
  const res = await fetch("/api/rose");
  roseData = await res.json();
  const div = document.getElementById("rose");
  div.innerHTML = "";
  roseData.forEach(r => {
    // Converti la stringa JSON in array
    let giocatori = [];
    try {
      giocatori = JSON.parse(r.giocatori);
    } catch(e) {
      console.error("Errore parsing giocatori:", e);
    }

    const ul = document.createElement("ul");
    giocatori.forEach(g => {
      const li = document.createElement("li");
      li.textContent = g;
      ul.appendChild(li);
    });

    const h3 = document.createElement("h3");
    h3.textContent = r.squadra;
    div.appendChild(h3);
    div.appendChild(ul);
  });

  // Squadre select
  const squadreSel = document.getElementById("squadreSel");
  squadreSel.innerHTML = "";
  roseData.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r.squadra;
    opt.textContent = r.squadra;
    squadreSel.appendChild(opt);
  });
  loadGiocatori();
}

// --- Carica lista giocatori cliccabile ---
function loadGiocatori() {
  const squadra = document.getElementById("squadreSel").value;
  const rosa = roseData.find(r => r.squadra === squadra);
  if (!rosa) return;
  const lista = document.getElementById("listaGiocatori");
  lista.innerHTML = "";
  titolari.clear();
  panchina.clear();

  let giocatori = [];
  try {
    giocatori = JSON.parse(rosa.giocatori);
  } catch(e) {
    console.error("Errore parsing giocatori:", e);
  }

  giocatori.forEach(g => {
    const btnT = document.createElement("button");
    btnT.textContent = g;
    btnT.className = "giocatore";
    btnT.onclick = () => {
      if (titolari.has(g)) {
        titolari.delete(g);
        btnT.style.background = "";
      } else {
        titolari.add(g);
        panchina.delete(g);
        btnT.style.background = "green";
        btnP.style.background = "";
      }
    };

    const btnP = document.createElement("button");
    btnP.textContent = "Panchina";
    btnP.onclick = () => {
      if (panchina.has(g)) {
        panchina.delete(g);
        btnP.style.background = "";
      } else {
        panchina.add(g);
        titolari.delete(g);
        btnP.style.background = "orange";
        btnT.style.background = "";
      }
    };

    lista.appendChild(btnT);
    lista.appendChild(btnP);
    lista.appendChild(document.createElement("br"));
  });
}
document.getElementById("squadreSel").addEventListener("change", loadGiocatori);

// --- Invia formazione ---
document.getElementById("btnInviaForm").addEventListener("click", async () => {
  if (titolari.size !== 5) return alert("Seleziona 5 titolari");
  if (panchina.size !== 3) return alert("Seleziona 3 in panchina");

  const squadra = document.getElementById("squadreSel").value;
  const password = document.getElementById("pwdForm").value.trim();

  const res = await fetch("/api/formazioni", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      squadra,
      password,
      titolari: Array.from(titolari),
      panchina: Array.from(panchina)
    })
  });

  const data = await res.json();
  document.getElementById("msgForm").textContent = JSON.stringify(data, null, 2);
  loadCalendario();
});

// --- Carica classifica ---
async function loadClassifica() {
  const res = await fetch("/api/classifica");
  const cls = await res.json();
  const tbl = document.getElementById("classificaTbl");
  tbl.innerHTML = "<tr><th>Squadra</th><th>Punti</th></tr>";
  cls.forEach(r => {
    tbl.innerHTML += `<tr><td>${r.squadra}</td><td>${r.punti}</td></tr>`;
  });
}

// --- Carica calendario ---
async function loadCalendario() {
  const res = await fetch("/api/formazioni");
  const cal = await res.json();
  const sel = document.getElementById("selGiornata");
  sel.innerHTML = "";

  // Popola select con tutte le giornate
  Object.keys(cal).forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    sel.appendChild(opt);
  });

  function mostraGiornata(giornata) {
    const data = cal[giornata];
    const container = document.getElementById("calendarioContainer");
    container.innerHTML = "";

    for (const [squadra, f] of Object.entries(data.squadre)) {
      const heading = document.createElement("h3");
      heading.textContent = squadra;
      container.appendChild(heading);

      const tbl = document.createElement("table");
      tbl.innerHTML = `
        <thead>
          <tr>
            <th>Giocatore</th>
            <th>Ruolo</th>
            <th>Voto</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = tbl.querySelector("tbody");

      f.titolari.forEach(g => {
        const tr = document.createElement("tr");
        const voto = (f.voti && f.voti[g]) || 0; // default 0 se non c'Ã¨ voto
        if (voto > 6) tr.style.backgroundColor = "#c8f7c5"; // verde chiaro
        tr.innerHTML = `<td>${g}</td><td>Titolare</td><td>${voto}</td>`;
        tbody.appendChild(tr);
      });

      (f.panchina||[]).forEach(g => {
        const tr = document.createElement("tr");
        const voto = (f.voti && f.voti[g]) || 0;
        if (voto > 6) tr.style.backgroundColor = "#c8f7c5"; // verde chiaro anche in panchina
        tr.innerHTML = `<td>${g}</td><td>Panchina</td><td>${voto}</td>`;
        tbody.appendChild(tr);
      });


      container.appendChild(tbl);
    }
  }

  // Mostra la prima giornata all'avvio
  mostraGiornata(Object.keys(cal)[0]);

  // Cambia giornata al select
  sel.addEventListener("change", () => {
    mostraGiornata(sel.value);
  });
}

// --- Calcolo giornata con panchina ---
document.getElementById("btnMostraCalcola").addEventListener("click", async () => {
  const res = await fetch("/api/calcola");
  const data = await res.json();
  const area = document.getElementById("calcArea");
  area.innerHTML = "";
  if (data.error) { area.textContent = data.error; return; }

  const form = document.createElement("form");
  form.innerHTML = `<h3>${data.giornata}</h3>`;
  for (const [squadra, f] of Object.entries(data.squadre)) {
    const div = document.createElement("div");
    div.innerHTML = `<h4>${squadra}</h4>`;
    [...f.titolari, ...(f.panchina||[])]
      .forEach(g => {
        div.innerHTML += `${g}: <input type="number" name="${squadra}::${g}" value="6"><br>`;
      });
    form.appendChild(div);
  }

  const pwd = document.createElement("input");
  pwd.type = "password";
  pwd.placeholder = "Password";
  pwd.id = "pwdCalc";
  form.appendChild(pwd);

  const btn = document.createElement("button");
  btn.textContent = "Calcola punteggi";
  form.appendChild(btn);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const voti = {};
    for (const [k, v] of fd.entries()) {
      if (k.includes("::")) {
        const [squadra, g] = k.split("::");
        if (!voti[squadra]) voti[squadra] = {};
        voti[squadra][g] = parseFloat(v);
      }
    }
    const res2 = await fetch("/api/calcola", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({password: pwd.value, voti})
    });
    const data2 = await res2.json();
    area.innerHTML = "<pre>" + JSON.stringify(data2,null,2) + "</pre>";
    loadClassifica();
    loadCalendario();
  });

  area.appendChild(form);
});

// --- Init ---
loadRose();
loadClassifica();
loadCalendario();
</script>
</body>
</html>
